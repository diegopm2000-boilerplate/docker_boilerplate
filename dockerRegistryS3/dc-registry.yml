# Docker registry with frontend securized with username and password
#
# Execute this before start the containers to generate the user/password entry:
# docker run --rm --entrypoint htpasswd registry:2 -Bbn <username> "<password>" > ~/htpasswd_backup/htpasswd
# example:
#
# docker run --rm --entrypoint htpasswd registry:2 -Bbn diego "alfa1beta2" > ~/htpasswd_backup/htpasswd
#
# For pushing images:
# 
# docker login -u <<username>> localhost:5000
# Password: <<type your password>>
#
# docker tag <<myimage>> localhost:5000/<<myimage>>
# docker push localhost:5000/<<myimage>>
#
# For identify your images, use your user
#
# docker tag <<myimage>> localhost:5000/<<username>>/<<myimage>>
# docker push localhost:5000/<<username>>/<<myimage>>

version: '3.5'
services:
  minio-s3:
    image: minio/minio
    ports:
      - 0.0.0.0:9000:9000
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    command: server /export
    volumes:
      - ./volumes/minio/export:/export
    networks:
      - registry_network
  registry:
    image: registry:latest
    ports:
      - "5000:5000"
    environment:
      REGISTRY_AUTH: 'htpasswd'
      REGISTRY_AUTH_HTPASSWD_REALM: 'YOUR_DOCKER_REGISTRY_REALM'
      REGISTRY_AUTH_HTPASSWD_PATH: '/httpasswd_storage/htpasswd'
      REGISTRY_STORAGE_REDIRECT_DISABLE: 'true'
    depends_on:
      - minio-s3
    volumes:
      - ~/htpasswd_backup:/httpasswd_storage
      - ./registry-config/config.yml:/etc/docker/registry/config.yml
    networks:
      - registry_network
  registry-frontend:
    image: konradkleine/docker-registry-frontend:v2
    restart: always
    environment:
      ENV_DOCKER_REGISTRY_HOST: 'registry'
      ENV_DOCKER_REGISTRY_PORT: 5000
    links:
      - registry
    ports:
      - "8080:80"
    networks:
      - registry_network

networks:
  registry_network:
    